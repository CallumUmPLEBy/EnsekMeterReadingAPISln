"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3168],{80808:(Ge,ae,g)=>{g.r(ae),g.d(ae,{plugin:()=>Je});var se=g(7238),t=g(68404),ue=g(35645),de=g(12006),fe=g(12580),pe=g(14835),v=g(19426),he=g(56991);const{Select:re,Input:ve}=pe.LegacyForms,X=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],Y=[{label:"second",value:1},{label:"millisecond",value:2}],Ee=s=>{const{onChange:e,value:a}=s,r=(0,he.L)();return t.createElement(t.Fragment,null,t.createElement("h5",null,"OpenTSDB settings"),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:7,htmlFor:`select-version-${r}`},"Version"),t.createElement(re,{inputId:`select-version-${r}`,options:X,value:X.find(n=>n.value===a.jsonData.tsdbVersion)??X[0],onChange:ne("tsdbVersion",a,e)})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:7,htmlFor:`select-resolution-${r}`},"Resolution"),t.createElement(re,{inputId:`select-resolution-${r}`,options:Y,value:Y.find(n=>n.value===a.jsonData.tsdbResolution)??Y[0],onChange:ne("tsdbResolution",a,e)})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:7,htmlFor:`lookup-input-${r}`},"Lookup limit"),t.createElement(ve,{id:`lookup-input-${r}`,type:"number",value:a.jsonData.lookupLimit??1e3,onChange:be("lookupLimit",a,e)})))},ne=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.value}})},be=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.currentTarget.value}})},Te=s=>{const{options:e,onOptionsChange:a}=s;return t.createElement(t.Fragment,null,t.createElement(de.E,{defaultUrl:"http://localhost:4242",dataSourceConfig:e,onChange:a}),ue.v.featureToggles.secureSocksDatasourceProxy&&t.createElement(fe.i,{options:e,onOptionsChange:a}),t.createElement(Ee,{value:e,onChange:a}))};var W=g(52423),we=g(8928),Z=g(72648),b=g(63134),j=g(46967),F=g(53217),G=g(77117),D=g(8944);const Ne=(0,W.css)({paddingRight:"4px"});function ye({query:s,onChange:e,onRunQuery:a,aggregators:r,fillPolicies:n,tsdbVersion:l}){const c=r.map(i=>(0,b.E)(i)),o=n.map(i=>(0,b.E)(i));return t.createElement("div",{className:"gf-form-inline","data-testid":oe.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Leave interval blank for auto or for example use ",t.createElement("code",null,"1m"))},"Down sample"),t.createElement(j.I,{width:25,className:Ne,"data-testid":oe.interval,placeholder:"interval",value:s.downsampleInterval??"",onChange:i=>{const m=i.currentTarget.value;e({...s,downsampleInterval:m})},onBlur:()=>a()})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(F.Ph,{className:"gf-form-input",value:s.downsampleAggregator?(0,b.E)(s.downsampleAggregator):void 0,options:c,onChange:({value:i})=>{i&&(e({...s,downsampleAggregator:i}),a())}})),l>=2&&t.createElement("div",{className:"gf-form"},t.createElement(G.W,{className:"width-6 query-keyword"},"Fill"),t.createElement(F.Ph,{inputId:"opentsdb-fillpolicy-select",value:s.downsampleFillPolicy?(0,b.E)(s.downsampleFillPolicy):void 0,options:o,onChange:({value:i})=>{i&&(e({...s,downsampleFillPolicy:i}),a())}})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword"},"Disable downsampling"),t.createElement(D.x,{value:s.disableDownsampling??!1,onChange:()=>{const i=s.disableDownsampling??!1;e({...s,disableDownsampling:!i}),a()}})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const oe={section:"opentsdb-downsample",interval:"downsample-interval"};var u=g(82897),le=g(31403),V=g(39904);function Ce({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,filterTypes:n,suggestTagValues:l}){const c=(0,Z.wW)(le.gN),[o,i]=(0,t.useState)(),[m,p]=(0,t.useState)(),[E,y]=(0,t.useState)(),[k,N]=(0,t.useState)(),[T,O]=(0,t.useState)(!1),[h,x]=(0,t.useState)("iliteral_or"),[L,M]=(0,t.useState)(""),[R,B]=(0,t.useState)(""),[A,U]=(0,t.useState)(!1),[J,_]=(0,t.useState)(""),ee=n.map(d=>(0,b.E)(d));function Q(){O(!T)}function f(){if(s.tags&&(0,u.size)(s.tags)>0){_("Please remove tags to use filters, tags and filters are mutually exclusive.");return}if(!T){O(!0);return}const d={type:h,tagk:L,filter:R,groupBy:A};s.filters=s.filters?s.filters.concat([d]):[d],x("literal_or"),M(""),B(""),U(!1),e(s),a(),Q()}function C(d){s.filters?.splice(d,1),e(s),a()}function P(d,S){C(S),M(d.tagk),B(d.filter),x(d.type),U(d.groupBy),f()}const ge=" ",H=(0,t.useCallback)((d,S)=>{const te=d.value??"";return S.split(ge).reduce((Qe,We)=>Qe&&te.toLowerCase().includes(We.toLowerCase()),!0)},[]);return t.createElement("div",{className:"gf-form-inline","data-testid":z.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Filters does not work with tags, either of the two will work but not both.")},"Filters"),s.filters&&s.filters.map((d,S)=>t.createElement(v.c,{key:S,width:"auto","data-testid":z.list+S},d.tagk," = ",d.type,"(",d.filter,"), groupBy = ",""+d.groupBy,t.createElement("button",{type:"button",className:c,onClick:()=>P(d,S)},t.createElement(V.J,{name:"pen"})),t.createElement("button",{type:"button",className:c,onClick:()=>C(S),"data-testid":z.remove},t.createElement(V.J,{name:"times"})))),!T&&t.createElement("button",{className:"gf-form-label",type:"button",onClick:Q,"aria-label":"Add filter"},t.createElement(V.J,{name:"plus"}))),T&&t.createElement("div",{className:"gf-form-inline"},t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:L?(0,b.E)(L):void 0,placeholder:"key",allowCustomValue:!0,filterOption:H,onOpenMenu:async()=>{p(!0);const S=(await r(s)).map(te=>(0,b.E)(te));i(S),p(!1)},isLoading:m,options:o,onChange:({value:d})=>{d&&M(d)}})),t.createElement("div",{className:"gf-form"},t.createElement(G.W,{className:"width-4 query-keyword"},"Type"),t.createElement(F.Ph,{inputId:"opentsdb-aggregator-select",value:h?(0,b.E)(h):void 0,options:ee,onChange:({value:d})=>{d&&x(d)}})),t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:R?(0,b.E)(R):void 0,placeholder:"filter",allowCustomValue:!0,filterOption:H,onOpenMenu:async()=>{if(!E){N(!0);const d=await l();y(d),N(!1)}},isLoading:k,options:E,onChange:({value:d})=>{d&&B(d)}})),t.createElement(v.c,{width:5,className:"query-keyword"},"Group by"),t.createElement(D.x,{value:A,onChange:()=>{U(!A)}}),t.createElement("div",{className:"gf-form"},J&&t.createElement("div",{className:"gf-form-label",title:J,"data-testid":z.error},t.createElement(V.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement("div",{className:"gf-form-label"},t.createElement("button",{type:"button",className:c,onClick:f},"add filter"),t.createElement("button",{type:"button",className:c,onClick:Q},t.createElement(V.J,{name:"times"}))))),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const z={section:"opentsdb-filter",list:"opentsdb-filter-list",error:"opentsdb-filter-error",remove:"opentsdb-filter-remove"};var Se=g(99151),Ve=g.n(Se);function xe({query:s,onChange:e,onRunQuery:a,suggestMetrics:r,aggregators:n}){const l=n.map(o=>(0,b.E)(o)),c=Ve()(o=>r(o),350);return t.createElement("div",{className:"gf-form-inline","data-testid":ie.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:8,className:"query-keyword"},"Metric"),t.createElement(F.qb,{width:25,inputId:"opentsdb-metric-select",className:"gf-form-input",value:s.metric?(0,b.E)(s.metric):void 0,placeholder:"Metric name",allowCustomValue:!0,loadOptions:c,defaultOptions:[],onChange:({value:o})=>{o&&(e({...s,metric:o}),a())}})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(F.Ph,{inputId:"opentsdb-aggregator-select",className:"gf-form-input",value:s.aggregator?(0,b.E)(s.aggregator):void 0,options:l,onChange:({value:o})=>{o&&(e({...s,aggregator:o}),a())}})),t.createElement("div",{className:"gf-form max-width-20"},t.createElement(v.c,{className:"query-keyword",width:6,tooltip:t.createElement("div",null,"Use patterns like $tag_tagname to replace part of the alias for a tag value")},"Alias"),t.createElement(j.I,{"data-testid":ie.alias,placeholder:"series alias",value:s.alias??"",onChange:o=>{const i=o.currentTarget.value;e({...s,alias:i})},onBlur:()=>a()})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const ie={section:"opentsdb-metricsection",alias:"metric-alias"};function Fe({query:s,onChange:e,onRunQuery:a,tsdbVersion:r}){return t.createElement("div",{className:"gf-form-inline","data-testid":K.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:8},"Rate"),t.createElement(D.x,{"data-testid":K.shouldComputeRate,value:s.shouldComputeRate??!1,onChange:()=>{const n=s.shouldComputeRate??!1;e({...s,shouldComputeRate:!n}),a()}})),s.shouldComputeRate&&t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:"auto"},"Counter"),t.createElement(D.x,{"data-testid":K.isCounter,value:s.isCounter??!1,onChange:()=>{const n=s.isCounter??!1;e({...s,isCounter:!n}),a()}})),s.shouldComputeRate&&s.isCounter&&t.createElement("div",{className:"gf-form"},t.createElement(G.W,{width:"auto",className:"query-keyword"},"Counter max"),t.createElement(j.I,{"data-testid":K.counterMax,placeholder:"max value",value:s.counterMax??"",onChange:n=>{const l=n.currentTarget.value;e({...s,counterMax:l})},onBlur:()=>a()}),t.createElement(G.W,{width:"auto",className:"query-keyword"},"Reset value"),t.createElement(j.I,{"data-testid":K.counterResetValue,placeholder:"reset value",value:s.counterResetValue??"",onChange:n=>{const l=n.currentTarget.value;e({...s,counterResetValue:l})},onBlur:()=>a()})),r>2&&t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:"auto"},"Explicit tags"),t.createElement(D.x,{"data-testid":K.explicitTags,value:s.explicitTags??!1,onChange:()=>{const n=s.explicitTags??!1;e({...s,explicitTags:!n}),a()}})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const K={section:"opentsdb-rate",shouldComputeRate:"opentsdb-shouldComputeRate",isCounter:"opentsdb-is-counter",counterMax:"opentsdb-counter-max",counterResetValue:"opentsdb-counter-reset-value",explicitTags:"opentsdb-explicit-tags"};function Ie({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,suggestTagValues:n,tsdbVersion:l}){const c=(0,Z.wW)(le.gN),[o,i]=(0,t.useState)(),[m,p]=(0,t.useState)(),[E,y]=(0,t.useState)(),[k,N]=(0,t.useState)(),[T,O]=(0,t.useState)(!1),[h,x]=(0,t.useState)(""),[L,M]=(0,t.useState)(""),[R,B]=(0,t.useState)("");function A(){O(!T)}function U(){if(s.filters&&(0,u.size)(s.filters)>0){B("Please remove filters to use tags, tags and filters are mutually exclusive.");return}if(!T){O(!0);return}if(s.tags&&(0,u.has)(s.tags,h)){const f="Duplicate tag key '"+h+"'.";B(f);return}s.tags||(s.tags={}),s.tags[h]=L,x(""),M(""),e(s),a(),A()}function J(f){delete s.tags[f],e(s),a()}function _(f,C){J(f),x(f),M(C),U()}const ee=" ",Q=(0,t.useCallback)((f,C)=>{const P=f.value??"";return C.split(ee).reduce((H,d)=>H&&P.toLowerCase().includes(d.toLowerCase()),!0)},[]);return t.createElement("div",{className:"gf-form-inline","data-testid":$.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:l>=2?t.createElement("div",null,"Please use filters, tags are deprecated in opentsdb 2.2"):void 0},"Tags"),s.tags&&Object.keys(s.tags).map((f,C)=>{const P=s.tags[f];return t.createElement(v.c,{key:C,width:"auto","data-testid":$.list+C},f,"=",P,t.createElement("button",{type:"button",className:c,onClick:()=>_(f,P)},t.createElement(V.J,{name:"pen"})),t.createElement("button",{type:"button",className:c,onClick:()=>J(f),"data-testid":$.remove},t.createElement(V.J,{name:"times"})))}),!T&&t.createElement("button",{className:"gf-form-label",type:"button",onClick:A,"aria-label":"Add tag"},t.createElement(V.J,{name:"plus"}))),T&&t.createElement("div",{className:"gf-form-inline"},t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:h?(0,b.E)(""+h):void 0,placeholder:"key",onOpenMenu:async()=>{p(!0);const C=(await r(s)).map(P=>(0,b.E)(P));i(C),p(!1)},isLoading:m,options:o,onChange:({value:f})=>{f&&x(f)}})),t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:L?(0,b.E)(L):void 0,placeholder:"value",allowCustomValue:!0,filterOption:Q,onOpenMenu:async()=>{if(!E){N(!0);const f=await n();y(f),N(!1)}},isLoading:k,options:E,onChange:({value:f})=>{f&&M(f)}})),t.createElement("div",{className:"gf-form"},R&&t.createElement("div",{className:"gf-form-label",title:R,"data-testid":$.error},t.createElement(V.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement("div",{className:"gf-form-label"},t.createElement("button",{type:"button",className:c,onClick:U},"add tag"),t.createElement("button",{type:"button",className:c,onClick:A},t.createElement(V.J,{name:"times"}))))),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const $={section:"opentsdb-tag",list:"opentsdb-tag-list",error:"opentsdb-tag-error",remove:"opentsdb-tag-remove"};function ke({datasource:s,onRunQuery:e,onChange:a,query:r,range:n,queries:l}){const c=(0,Z.wW)(Oe),[o,i]=(0,t.useState)(["avg","sum","min","max","dev","zimsum","mimmin","mimmax"]),m=["none","nan","null","zero"],[p,E]=(0,t.useState)(["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"]),y=s.tsdbVersion;r.aggregator||(r.aggregator="sum"),r.downsampleAggregator||(r.downsampleAggregator="avg"),r.downsampleFillPolicy||(r.downsampleFillPolicy="none"),s.getAggregators().then(h=>{h.length!==0&&i(h)}),s.getFilterTypes().then(h=>{h.length!==0&&E(h)});async function k(h){return s.metricFindQuery(`metrics(${h})`).then(O)}async function N(){return s.metricFindQuery("suggest_tagv()").then(O)}async function T(h){return s.suggestTagKeys(h)}function O(h){return h.map(x=>({value:we.QX.escapeHtml(x.text),description:x.text}))}return t.createElement("div",{className:c.container,"data-testid":Pe.editor},t.createElement("div",{className:c.visualEditor},t.createElement(xe,{query:r,onChange:a,onRunQuery:e,suggestMetrics:k,aggregators:o}),t.createElement(ye,{query:r,onChange:a,onRunQuery:e,aggregators:o,fillPolicies:m,tsdbVersion:y}),y>=2&&t.createElement(Ce,{query:r,onChange:a,onRunQuery:e,filterTypes:p,suggestTagValues:N,suggestTagKeys:T}),t.createElement(Ie,{query:r,onChange:a,onRunQuery:e,suggestTagValues:N,suggestTagKeys:T,tsdbVersion:y}),t.createElement(Fe,{query:r,onChange:a,onRunQuery:e,tsdbVersion:y})))}function Oe(s){return{container:W.css`
      display: flex;
    `,visualEditor:W.css`
      flex-grow: 1;
    `,toggleButton:W.css`
      margin-left: ${s.spacing(.5)};
    `}}const Pe={editor:"opentsdb-editor"};var Le=g(46060),Me=g(16313),q=g(53786),I=g(3363),Ae=g(94514),w=g(2101),ce=g(16911),De=g(21053),me=g(54899),Ke=g(98639);const Re=s=>{const{query:e,onChange:a}=s,[r,n]=(0,t.useState)(e.target??""),[l,c]=(0,t.useState)(e.isGlobal??!1),o=(m,p)=>{a({...e,[m]:p,fromAnnotations:!0})},i=m=>{m=!m,c(m),o("isGlobal",m)};return t.createElement("div",{className:"gf-form-group"},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:12},"OpenTSDB metrics query"),t.createElement(j.I,{value:r,onChange:m=>n(m.currentTarget.value??""),onBlur:()=>o("target",r),placeholder:"events.eventname"})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:12},"Show Global Annotations?"),t.createElement(D.x,{value:l,onChange:m=>i(l)})))},Be=s=>({fromAnnotations:!0,target:s.target??"",name:s.name??"",isGlobal:s.isGlobal??!1}),Ue=s=>{const e=s.target&&typeof s.target!="string"?s.target:Be(s);return s.target=e,s};class je extends se.MF{constructor(e,a=(0,Ke.J)()){super(e),this.templateSrv=a,this.type="opentsdb",this.url=e.url,this.name=e.name,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,e.jsonData=e.jsonData||{},this.tsdbVersion=e.jsonData.tsdbVersion||1,this.tsdbResolution=e.jsonData.tsdbResolution||1,this.lookupLimit=e.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null,this.annotations={QueryEditor:Re,prepareAnnotation:Ue}}query(e){if(e.targets.some(o=>o.fromAnnotations)){const o=[];for(const i of e.targets)i.target&&o.push(new Le.y(m=>{this.annotationEvent(e,i).then(p=>m.next({data:[(0,ce.g0)(p)]})).catch(p=>m.next({data:[(0,ce.g0)([])]})).finally(()=>m.complete())}));return(0,Me.T)(...o)}const a=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),r=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),n=[];(0,u.each)(e.targets,o=>{o.metric&&n.push(this.convertTargetToQuery(o,e,this.tsdbVersion))});const l=(0,u.compact)(n);if((0,u.isEmpty)(l))return(0,q.of)({data:[]});const c={};return(0,u.each)(l,o=>{o.filters&&o.filters.length>0?(0,u.each)(o.filters,i=>{c[i.tagk]=!0}):(0,u.each)(o.tags,(i,m)=>{c[m]=!0})}),e.targets=(0,u.filter)(e.targets,o=>o.hide!==!0),this.performTimeSeriesQuery(l,a,r).pipe((0,Ae.K)(o=>{throw o?.data?.error?.message||"Error performing time series query."}),(0,w.U)(o=>{const i=this.mapMetricsToTargets(o.data,e,this.tsdbVersion);return{data:(0,u.map)(o.data,(p,E)=>(E=i[E],E===-1&&(E=0),this._saveTagKeys(p),this.transformMetricData(p,c,e.targets[E],e,this.tsdbResolution)))}}))}annotationEvent(e,a){const r=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),n=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),l=[],c=[];l.push({aggregator:"sum",metric:a.target});const o=(0,u.compact)(l);return(0,I.n)(this.performTimeSeriesQuery(o,r,n).pipe((0,w.U)(i=>{if(i.data[0]){let m=i.data[0].annotations;a.isGlobal&&(m=i.data[0].globalAnnotations),m&&(0,u.each)(m,p=>{const E={text:p.description,time:Math.floor(p.startTime)*1e3,annotation:a};c.push(E)})}return c})))}targetContainsTemplate(e){if(e.filters&&e.filters.length>0){for(let a=0;a<e.filters.length;a++)if(this.templateSrv.containsTemplate(e.filters[a].filter))return!0}if(e.tags&&Object.keys(e.tags).length>0){for(const a in e.tags)if(this.templateSrv.containsTemplate(e.tags[a]))return!0}return!1}performTimeSeriesQuery(e,a,r){let n=!1;this.tsdbResolution===2&&(n=!0);const l={start:a,queries:e,msResolution:n,globalAnnotations:!0};this.tsdbVersion===3&&(l.showQuery=!0),r&&(l.end=r);const c={method:"POST",url:this.url+"/api/query",data:l};return this._addCredentialOptions(c),(0,me.i)().fetch(c)}suggestTagKeys(e){const a=e.metric??"";return Promise.resolve(this.tagKeys[a]||[])}_saveTagKeys(e){const a=Object.keys(e.tags);(0,u.each)(e.aggregateTags,r=>{a.push(r)}),this.tagKeys[e.metric]=a}_performSuggestQuery(e,a){return this._get("/api/suggest",{type:a,q:e,max:this.lookupLimit}).pipe((0,w.U)(r=>r.data))}_performMetricKeyValueLookup(e,a){if(!e||!a)return(0,q.of)([]);const r=a.split(",").map(o=>o.trim()),n=r[0];let l=n+"=*";r.length>1&&(l+=","+r.splice(1).join(","));const c=e+"{"+l+"}";return this._get("/api/search/lookup",{m:c,limit:this.lookupLimit}).pipe((0,w.U)(o=>{o=o.data.results;const i=[];return(0,u.each)(o,m=>{i.indexOf(m.tags[n])===-1&&i.push(m.tags[n])}),i}))}_performMetricKeyLookup(e){return e?this._get("/api/search/lookup",{m:e,limit:1e3}).pipe((0,w.U)(a=>{a=a.data.results;const r=[];return(0,u.each)(a,n=>{(0,u.each)(n.tags,(l,c)=>{r.indexOf(c)===-1&&r.push(c)})}),r})):(0,q.of)([])}_get(e,a){const r={method:"GET",url:this.url+e,params:a};return this._addCredentialOptions(r),(0,me.i)().fetch(r)}_addCredentialOptions(e){(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth})}metricFindQuery(e){if(!e)return Promise.resolve([]);let a;try{a=this.templateSrv.replace(e,{},"distributed")}catch(N){return Promise.reject(N)}const r=N=>(0,u.map)(N,T=>({text:T})),n=/metrics\((.*)\)/,l=/tag_names\((.*)\)/,c=/tag_values\((.*?),\s?(.*)\)/,o=/suggest_tagk\((.*)\)/,i=/suggest_tagv\((.*)\)/,m=a.match(n);if(m)return(0,I.n)(this._performSuggestQuery(m[1],"metrics").pipe((0,w.U)(r)));const p=a.match(l);if(p)return(0,I.n)(this._performMetricKeyLookup(p[1]).pipe((0,w.U)(r)));const E=a.match(c);if(E)return(0,I.n)(this._performMetricKeyValueLookup(E[1],E[2]).pipe((0,w.U)(r)));const y=a.match(o);if(y)return(0,I.n)(this._performSuggestQuery(y[1],"tagk").pipe((0,w.U)(r)));const k=a.match(i);return k?(0,I.n)(this._performSuggestQuery(k[1],"tagv").pipe((0,w.U)(r))):Promise.resolve([])}testDatasource(){return(0,I.n)(this._performSuggestQuery("cpu","metrics").pipe((0,w.U)(()=>({status:"success",message:"Data source is working"}))))}getAggregators(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=(0,I.n)(this._get("/api/aggregators").pipe((0,w.U)(e=>e.data&&(0,u.isArray)(e.data)?e.data.sort():[]))),this.aggregatorsPromise)}getFilterTypes(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=(0,I.n)(this._get("/api/config/filters").pipe((0,w.U)(e=>e.data?Object.keys(e.data).sort():[]))),this.filterTypesPromise)}transformMetricData(e,a,r,n,l){const c=this.createMetricLabel(e,r,a,n),o=[];return(0,u.each)(e.dps,(i,m)=>{l===2?o.push([i,m*1]):o.push([i,m*1e3])}),{target:c,datapoints:o}}createMetricLabel(e,a,r,n){if(a.alias){const o=(0,u.clone)(n.scopedVars||{});return(0,u.each)(e.tags,(i,m)=>{o["tag_"+m]={value:i}}),this.templateSrv.replace(a.alias,o)}let l=e.metric;const c=[];return(0,u.isEmpty)(e.tags)||(0,u.each)((0,u.toPairs)(e.tags),o=>{(0,u.has)(r,o[0])&&c.push(o[0]+"="+o[1])}),(0,u.isEmpty)(c)||(l+="{"+c.join(", ")+"}"),l}convertTargetToQuery(e,a,r){if(!e.metric||e.hide)return null;const n={metric:this.templateSrv.replace(e.metric,a.scopedVars,"pipe"),aggregator:"avg"};if(e.aggregator&&(n.aggregator=this.templateSrv.replace(e.aggregator)),e.shouldComputeRate&&(n.rate=!0,n.rateOptions={counter:!!e.isCounter},e.counterMax&&e.counterMax.length&&(n.rateOptions.counterMax=parseInt(e.counterMax,10)),e.counterResetValue&&e.counterResetValue.length&&(n.rateOptions.resetValue=parseInt(e.counterResetValue,10)),r>=2&&(n.rateOptions.dropResets=!n.rateOptions.counterMax&&(!n.rateOptions.ResetValue||n.rateOptions.ResetValue===0))),!e.disableDownsampling){let l=this.templateSrv.replace(e.downsampleInterval||a.interval);l.match(/\.[0-9]+s/)&&(l=parseFloat(l)*1e3+"ms"),n.downsample=l+"-"+e.downsampleAggregator,e.downsampleFillPolicy&&e.downsampleFillPolicy!=="none"&&(n.downsample+="-"+e.downsampleFillPolicy)}if(e.filters&&e.filters.length>0)n.filters=(0,u.cloneDeep)(e.filters),n.filters&&this.interpolateVariablesInFilters(n,a);else if(n.tags=(0,u.cloneDeep)(e.tags),n.tags)for(const l in n.tags)n.tags[l]=this.templateSrv.replace(n.tags[l],a.scopedVars,"pipe");return e.explicitTags&&(n.explicitTags=!0),n}interpolateVariablesInFilters(e,a){e.filters=e.filters?.map(r=>(r.tagk=this.templateSrv.replace(r.tagk,a.scopedVars,"pipe"),r.filter=this.templateSrv.replace(r.filter,a.scopedVars,"pipe"),r))}mapMetricsToTargets(e,a,r){let n,l;return(0,u.map)(e,c=>r===3?c.query.index:(0,u.findIndex)(a.targets,o=>o.filters&&o.filters.length>0?o.metric===c.metric:o.metric===c.metric&&(0,u.every)(o.tags,(i,m)=>(n=this.templateSrv.replace(i,a.scopedVars,"pipe"),l=n.split("|"),(0,u.includes)(l,c.tags[m])||n==="*"))))}interpolateVariablesInQueries(e,a){return e.length?e.map(r=>({...r,metric:this.templateSrv.replace(r.metric,a)})):e}convertToTSDBTime(e,a,r){return e==="now"?null:(e=De.parse(e,a,r),e.valueOf())}}const Je=new se.hf(je).setQueryEditor(ke).setConfigEditor(Te)}}]);

//# sourceMappingURL=opentsdbPlugin.ebf34a716bb08e023d8f.js.map